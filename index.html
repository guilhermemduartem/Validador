<!DOCTYPE html>
<html>

<head>
  <title>Miketec Validador</title>
  <style>
    :root {
      --azul-principal: #2b3a67;
      --azul-secundario: #3f51b5;
      --azul-claro: #e3f2fd;
      --verde-sucesso: #4caf50;
      --vermelho-erro: #f44336;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--azul-claro);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 3px solid var(--azul-principal);
      padding-bottom: 20px;
    }

    .header h1 {
      color: var(--azul-principal);
      margin: 0;
      font-size: 2.5em;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .info-panel {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .info-panel.active {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .info-item {
      background: var(--azul-claro);
      padding: 10px;
      border-radius: 5px;
      text-align: center;
    }

    .info-item h3 {
      margin: 0;
      color: var(--azul-principal);
      font-size: 0.9em;
      text-transform: uppercase;
    }

    .info-item p {
      margin: 5px 0 0;
      font-size: 1.2em;
      font-weight: bold;
      color: var(--azul-secundario);
    }

    .upload-section {
      text-align: center;
      margin-bottom: 30px;
    }

    input[type="file"] {
      display: none;
    }

    .custom-file-upload {
      border: 2px solid var(--azul-secundario);
      color: var(--azul-secundario);
      padding: 12px 25px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
      display: inline-block;
      margin-right: 10px;
    }

    .custom-file-upload:hover {
      background: var(--azul-secundario);
      color: white;
    }

    button {
      background: var(--azul-secundario);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }

    button:hover {
      background: var(--azul-principal);
      transform: translateY(-2px);
    }

    .output-section {
      margin-top: 20px;
    }

    .cnab-section {
      background: #fff;
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .cnab-header {
      background: var(--azul-principal);
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
    }

    .cnab-content {
      padding: 20px;
    }

    .cnab-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px;
      align-items: center;
    }

    .cnab-label {
      color: var(--azul-principal);
      font-weight: 500;
      padding-right: 15px;
      text-align: right;
    }

    .cnab-value {
      color: var(--azul-secundario);
      font-weight: bold;
      padding: 4px 8px;
      background: var(--azul-claro);
      border-radius: 4px;
    }

    .resumo-section {
      background: var(--azul-principal);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .resumo-title {
      text-align: center;
      font-size: 1.5em;
      margin-bottom: 15px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
    }

    .resumo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }

    .resumo-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 5px;
      text-align: center;
    }

    .resumo-label {
      font-size: 0.9em;
      opacity: 0.8;
      margin-bottom: 5px;
    }

    .resumo-value {
      font-size: 1.4em;
      font-weight: bold;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      .header h1 {
        font-size: 1.8em;
      }

      button {
        width: 100%;
        margin-top: 10px;
      }

      .custom-file-upload {
        width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
      }

      .info-grid {
        grid-template-columns: 1fr;
      }

      .cnab-grid {
        grid-template-columns: 1fr;
      }

      .cnab-label {
        text-align: left;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Miketec Validador CNAB</h1>
    </div>

    <div class="info-panel" id="infoPanel">
      <div class="info-grid">
        <div class="info-item">
          <h3>Tipo de Registro</h3>
          <p id="tipoRegistro">-</p>
        </div>
        <div class="info-item">
          <h3>Valor Total do Serviço</h3>
          <p id="totalLinhas">-</p>
        </div>
        <div class="info-item">
          <h3>Valor Retido</h3>
          <p id="linhaAtual">-</p>
        </div>
        <div class="info-item">
          <h3>Status</h3>
          <p id="status">-</p>
        </div>
        <div class="info-item">
          <h3>Quantidade de NFs</h3>
          <p id="quantidadeNFs">-</p>
        </div>
      </div>
    </div>

    <div class="upload-section">
      <label class="custom-file-upload">
        <input type="file" id="cnabFile" accept=".txt">
        Selecionar Arquivo
      </label>
      <button onclick="processarCNAB()">Validar Arquivo</button>
    </div>

    <div id="output" class="output-section"></div>
  </div>

  <script>
    function formatarMoeda(valor) {
      return `R$ ${parseFloat(valor).toFixed(2).replace('.', ',')}`;
    }

    function atualizarInfoPanel(tipo, totalServicos, totalRetencao, quantidadeNFs, status) {
      document.getElementById('infoPanel').classList.add('active');
      document.getElementById('tipoRegistro').textContent = tipo || '-';
      document.getElementById('totalLinhas').textContent = formatarMoeda(totalServicos) || '-';
      document.getElementById('linhaAtual').textContent = formatarMoeda(totalRetencao) || '-';
      document.getElementById('quantidadeNFs').textContent = quantidadeNFs || '-';
      document.getElementById('status').textContent = status || '-';
    }

    function criarSecaoCNAB(titulo, dados) {
      const section = document.createElement('div');
      section.className = 'cnab-section';

      const header = document.createElement('div');
      header.className = 'cnab-header';
      header.textContent = titulo;
      section.appendChild(header);

      const content = document.createElement('div');
      content.className = 'cnab-content';

      const grid = document.createElement('div');
      grid.className = 'cnab-grid';

      dados.forEach(([rotulo, valor]) => {
        const label = document.createElement('div');
        label.className = 'cnab-label';
        label.textContent = rotulo;

        const value = document.createElement('div');
        value.className = 'cnab-value';
        value.textContent = valor || '-';

        grid.appendChild(label);
        grid.appendChild(value);
      });

      content.appendChild(grid);
      section.appendChild(content);
      return section;
    }

    function criarResumoFinal(totalServico, totalRetencao) {
      const section = document.createElement('div');
      section.className = 'resumo-section';

      const title = document.createElement('div');
      title.className = 'resumo-title';
      title.textContent = 'Resumo Final';
      section.appendChild(title);

      const grid = document.createElement('div');
      grid.className = 'resumo-grid';

      const items = [
        ['Total de Serviços', formatarMoeda(totalServico)],
        ['Total de Retenções', formatarMoeda(totalRetencao)]
      ];

      items.forEach(([label, value]) => {
        const item = document.createElement('div');
        item.className = 'resumo-item';

        const labelEl = document.createElement('div');
        labelEl.className = 'resumo-label';
        labelEl.textContent = label;

        const valueEl = document.createElement('div');
        valueEl.className = 'resumo-value';
        valueEl.textContent = value;

        item.appendChild(labelEl);
        item.appendChild(valueEl);
        grid.appendChild(item);
      });

      section.appendChild(grid);
      return section;
    }

    function processarCNAB() {
      const file = document.getElementById('cnabFile').files[0];
      if (!file) return alert('Selecione um arquivo .txt primeiro!');

      const reader = new FileReader();
      reader.onload = function (e) {
        const linhas = e.target.result.split('\n').filter(linha => linha.trim());
        const output = document.getElementById('output');
        output.innerHTML = ''; // Limpa o conteúdo anterior

        let totalServico = 0;
        let totalRetencao = 0;
        let contadorNF = 0; // Inicializa o contador de NFs em 0

        // Atualiza o total de linhas
        atualizarInfoPanel('-', totalServico, totalRetencao, contadorNF, 'Iniciando processamento');

        // Processa cada linha
        linhas.forEach((linha, idx) => {
          if (!linha) return;

          let tipoRegistro = '';
          let status = 'Processando';

          if (linha.startsWith('1')) {
            tipoRegistro = 'Cabeçalho';
            const dados = [
              ['Tipo do Registro', linha.slice(0, 1)],
              ['Inscrição do Contribuinte', linha.slice(1, 8)],
              ['Versão do Lay-Out', linha.slice(8, 14)],
              ['Identificação da Remessa', linha.slice(14, 25)]
            ];
            output.appendChild(criarSecaoCNAB('Cabeçalho', dados));
          }
          else if (linha.startsWith('2')) {
            tipoRegistro = 'Nota Fiscal';
            const dados = [
              ['Tipo do Registro', linha.slice(0, 1)],
              ['Tipo do RPS', linha.slice(1, 6)],
              ['Série do RPS', linha.slice(6, 10)],
              ['Série da NF-e', linha.slice(10, 15)],
              ['Número do RPS', linha.slice(15, 25)],
              ['Data do RPS', linha.slice(25, 33)],
              ['Hora do RPS', linha.slice(33, 39)],
              ['Situação do RPS', linha.slice(39, 40)],
              ['Código de Motivo de Cancelamento', linha.slice(40, 42)],
              ['Número da NF-e a ser cancelada/substituída', linha.slice(42, 49)],
              ['Série da NF-e a ser cancelada/substituída', linha.slice(49, 54)],
              ['Data de emissão da NF-e a ser cancelada/substituída', linha.slice(54, 62)],
              ['Descrição do Cancelamento', linha.slice(62, 242)],
              ['Código do Serviço Prestado', linha.slice(242, 251)],
              ['Local da Prestação do Serviço', linha.slice(251, 252)],
              ['Serviço Prestado em Vias Públicas', linha.slice(252, 253)],
              ['Endereço Logradouro do Serviço Prestado', linha.slice(253, 328)],
              ['Número Logradouro do Serviço Prestado', linha.slice(328, 337)],
              ['Complemento Logradouro do Serviço Prestado', linha.slice(337, 367)],
              ['Bairro Logradouro do Serviço Prestado', linha.slice(367, 407)],
              ['Cidade Logradouro do Serviço Prestado', linha.slice(407, 447)],
              ['UF Logradouro do Serviço Prestado', linha.slice(447, 449)],
              ['CEP Logradouro do Serviço Prestado', linha.slice(449, 457)],
              ['Quantidade de Serviço', linha.slice(457, 463)],
              ['Valor do Serviço', linha.slice(463, 478)],
              ['Reservado', linha.slice(478, 483)],
              ['Valor Total das Retenções', linha.slice(483, 498)],
              ['Tomador Estrangeiro', linha.slice(498, 499)],
              ['País da Nacionalidade do Tomador Estrangeiro', linha.slice(499, 502)],
              ['Serviço Prestado é Exportação', linha.slice(502, 503)],
              ['Indicador do CPF/CNPJ do Tomador', linha.slice(503, 504)],
              ['CPF/CNPJ do Tomador', linha.slice(504, 518)],
              ['Razão Social / Nome do Tomador', linha.slice(518, 578)],
              ['Endereço Logradouro Tomador', linha.slice(578, 653)],
              ['Número Logradouro Tomador', linha.slice(653, 662)],
              ['Complemento Logradouro Tomador', linha.slice(662, 692)],
              ['Bairro Logradouro Tomador', linha.slice(692, 732)],
              ['Cidade Logradouro Tomador', linha.slice(732, 772)],
              ['UF Logradouro Tomador', linha.slice(772, 774)],
              ['CEP Logradouro Tomador', linha.slice(774, 782)],
              ['E-mail Tomador', linha.slice(782, 934)],
              ['Fatura', linha.slice(934, 940)],
              ['Valor Fatura', linha.slice(940, 955)],
              ['Forma de Pagamento', linha.slice(955, 970)],
              ['Discriminação do Serviço', linha.slice(970, 1970)]
            ];

            // Adicionando os console.log para depuração
            dados.forEach(([descricao, valor]) => {
              console.log(`${descricao}: ${valor.trim()}`);
            });

            output.appendChild(criarSecaoCNAB(`Nota Fiscal ${String(++contadorNF).padStart(3, '0')}`, dados));
            totalServico += parseInt(linha.substring(464, 478).trim() || 0) / 100;
            totalRetencao += parseInt(linha.substring(483, 498).trim() || 0) / 100;
          }
          else if (linha.startsWith('3')) {
            tipoRegistro = 'Retenção';
            const dados = [
              ['Tipo do Registro', linha.slice(0, 1)],
              ['Código de Outros Valores', linha.slice(1, 3)],
              ['Valor', linha.slice(3, 18)]
            ];
            output.appendChild(criarSecaoCNAB('Retenção', dados));
          }
          else if (linha.startsWith('9')) {
            tipoRegistro = 'Rodapé';
            const dados = [
              ['Tipo do Registro', linha.slice(0, 1)],
              ['Número Total de Linhas', linha.slice(1, 8)],
              ['Valor Total dos Serviços', linha.slice(8, 23)],
              ['Valor Total das Retenções', linha.slice(23, 38)]
            ];
            output.appendChild(criarSecaoCNAB('Rodapé', dados));
          }

          // Atualiza o painel de informações para cada linha
          atualizarInfoPanel(tipoRegistro, formatarMoeda(totalServico), formatarMoeda(totalRetencao), contadorNF, status);
        });

        // Adiciona o resumo final
        output.appendChild(criarResumoFinal(totalServico, totalRetencao));
        atualizarInfoPanel('Concluído', totalServico, totalRetencao, contadorNF, 'Processamento finalizado');
      };
      reader.readAsText(file);
    }
  </script>
</body>

</html>